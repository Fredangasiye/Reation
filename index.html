<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relation | Relational Alignment & Survival Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            overflow-x: hidden;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .slide-up {
            animation: slideUp 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quick-fade {
            animation: quickFade 0.2s ease-out forwards;
        }

        @keyframes quickFade {
            from {
                opacity: 0.8;
            }

            to {
                opacity: 1;
            }
        }

        .progress-bar {
            transition: width 0.3s ease-in-out;
        }

        .option-card {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .option-card:hover {
            transform: scale(1.01);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .option-card.selected {
            background-color: rgba(139, 92, 246, 0.2);
            border-color: #8b5cf6;
            transform: scale(0.98);
        }

        .option-card:active {
            transform: scale(0.98);
        }

        .loader {
            border-top-color: #8b5cf6;
            animation: spinner 0.8s linear infinite;
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .vibrant-gradient {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .blur-content {
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- App Container -->
    <div id="app"
        class="w-full max-w-2xl mx-auto shadow-2xl rounded-3xl overflow-hidden glass min-h-[600px] flex flex-col uppercase-none">
        <!-- Progress Bar -->
        <div id="progress-container" class="hidden w-full h-1 bg-slate-800">
            <div id="progress-bar" class="h-full vibrant-gradient progress-bar" style="width: 0%"></div>
        </div>

        <!-- Render Target -->
        <div id="view-content" class="flex-grow flex flex-col p-8 md:p-12 relative h-full">
            <!-- Content gets injected here -->
        </div>
    </div>

    <script>
        // --- CONSTANTS & DATA ---
        const WEBHOOK_URL = "INSERT_YOUR_URL_HERE";

        const DOMAINS = {
            1: "Conflict Escalation Risk (CER)",
            2: "Repair Velocity Gap (RVG)",
            3: "Financial Governance Misalignment (FGM)",
            4: "Authority Structure Tension (AST)",
            5: "Attachment Trigger Instability (ATI)",
            6: "Stress Endurance Simulation"
        };

        const ARCHETYPE_DATA = {
            A: {
                title: "The Challenger (Dominant)",
                shortDesc: "You are a 'Take-Charge' leader. Your data shows that in public disagreements, managing the social calendar, or facing conflict, you naturally assert control.",
                description: "You possess a high-ego/dominant drive, prioritizing leadership, efficiency, and individual sovereignty within the relationship.",
                factors: [
                    "Conflict: You tend to counter-attack and value winning the argument over immediate repair.",
                    "Finance: You view money as a tool for power and autonomy, often seeking CEO-level control.",
                    "Intimacy: You seek validation through achievement and may view connection as a transaction.",
                    "Vision: You have a singular mission and expect your partner to align with your logistical path."
                ],
                advice: "Fred, true leadership requires you to actively pause and invite Cat into the final decision, ensuring she doesn't feel like a passenger in her own life."
            },
            B: {
                title: "The Strategist (Avoidant)",
                shortDesc: "You are highly analytical and value logic. Under stress, your instinct is to detach emotionally to maintain a sense of objective safety.",
                description: "You value logical distance and personal space, often detaching emotionally when the 'temperature' in the room gets too high.",
                factors: [
                    "Conflict: Your default is withdrawal or the silent treatment as a means of self-protection.",
                    "Finance: You maintain strict stewardship but may use financial opacity as a shield for independence.",
                    "Intimacy: You retreat into hobbies or screens when stressed instead of initiating connection.",
                    "Vision: You avoid long-term labels and deep commitments until absolute logical safety is established."
                ],
                advice: "Withdrawal is a slow leak in intimacy. You must practice the 'Safe Return'—even if you need space, give your partner a specific re-engagement time."
            },
            C: {
                title: "The Peacemaker (Secure)",
                shortDesc: "Day-to-day, you are very steady. You prioritize harmony and de-escalate tension through collaborative, attachment-first logic.",
                description: "You have a baseline for emotional security and transparency, viewing your relationship as a unified, collaborative team.",
                factors: [
                    "Conflict: You prioritize pause-and-regulate over reactivity and seek repair within hours.",
                    "Finance: Total transparency is your default, viewing money as a shared resource for a shared team.",
                    "Intimacy: You initiate connection with your partner first when feeling disconnected.",
                    "Vision: You operate with a 'Covenant' mindset—sacrificial love and mutual humility are your core drivers."
                ],
                advice: "Your security is an anchor. However, you must ensure your voice isn't lost in the pursuit of peace. Speak your full truth, not just the harmonious part."
            },
            D: {
                title: "The Nurturer (Passive)",
                shortDesc: "You are adaptive and steady. But under severe stress or major life changes, your instinct is to step back and let a stronger personality take the wheel.",
                description: "You are highly empathetic and adaptive, often suppressesing your own needs to maintain the comfort and schedule of your partner.",
                factors: [
                    "Conflict: You apologize immediately just to stop the fight, even when you aren't at fault.",
                    "Finance: You prefer for your partner to handle all logistics to avoid the stress of decisions.",
                    "Intimacy: You seek validation through being 'needed' and may struggle with boundaries.",
                    "Vision: You mold your life to follow your partner's path, often at the expense of your own voice."
                ],
                advice: "Cat, you must practice voicing your needs before the stress boils over. Your honest dissent is a gift to the relationship's health."
            }
        };

        const PAIRING_DYNAMICS = {
            "AA": { status: "High Risk", dynamic: "The CEO Collision", choices: "Constant power struggles where winning the argument matters more than the person.", social: "Competitive social posturing that can leave third parties feeling the tension." },
            "AB": { status: "Moderate Risk", dynamic: "The Pursuer & The Ghost", choices: "One drives while the other detaches, leading to a decision-making vacuum.", social: "One manages the room while the other seeks an exit or retreats into a screen." },
            "AC": { status: "Optimized", dynamic: "The Anchor & The Visionary", choices: "A strong lead supported by an emotionally secure foundation.", social: "A balanced team where one leads and the other stabilizes the social vibe." },
            "AD": { status: "Moderate Risk", dynamic: "The Driver and The Yielder", choices: "High Friction Potential. Fred likes to drive, and Cat is willing to let him. However, Fred's tendency to take control can cause Cat to experience blocks.", social: "Fred's instinct to assert himself publicly can unintentionally make Cat feel sidelined or unheard." },
            "BA": { status: "Moderate Risk", dynamic: "The Ghost & The Pursuer", choices: "Withdrawal triggers more dominance, creating a cycle of chase and retreat.", social: "Social settings become a battleground for independence vs. control." },
            "BB": { status: "High Risk", dynamic: "The Parallel Lives", choices: "Decision-making is stalled by mutual detachment and fear of vulnerability.", social: "A relationship that looks functional from the outside but feels hollow/isolated on the inside." },
            "BC": { status: "Moderate Risk", dynamic: "The Anchor & The Strategist", choices: "The anchor seeks connection while the strategist seeks logic/space.", social: "A steady social presence with occasional moments of emotional disconnect." },
            "BD": { status: "Moderate Risk", dynamic: "The Detached Lead", choices: "One retreats into logic while the other suppresses needs to maintain peace.", social: "Socially awkward or reserved, lacking a clear 'connector' personality." },
            "CA": { status: "Optimized", dynamic: "The Visionary & The Anchor", choices: "Mutual respect where leadership is invited and stability is cherished.", social: "A socially warm and influential couple that invites others in." },
            "CB": { status: "Moderate Risk", dynamic: "The Strategist & The Anchor", choices: "Balance is maintained but emotional depth requires intentional effort from the strategist.", social: "A calm social presence that can feel slightly distant or private." },
            "CC": { status: "High Alignment", dynamic: "The Covenant Core", choices: "Transparent, sacrificial decision-making that prioritizes the 'Us'.", social: "Naturally hospitable and emotionally safe social leaders." },
            "CD": { status: "Optimized", dynamic: "The Steady Team", choices: "High alignment with low conflict, though both must avoid 'peace at all costs'.", social: "Warm, inviting, and highly relatable social presence." },
            "DA": { status: "Moderate Risk", dynamic: "The Yielder and The Driver", choices: "Fred likes to drive, and Cat is willing to let him, but at the cost of her voice.", social: "Cat feels like a passenger in social settings managed by Fred's initiative." },
            "DB": { status: "Moderate Risk", dynamic: "The Accommodator", choices: "One adapts to the other's logical distance, creating a quiet but lonely dynamic.", social: "A socially passive couple that often follows the lead of friends." },
            "DC": { status: "Optimized", dynamic: "The Steady Team", choices: "Great stability, provided the nurturer feels safe enough to be honest.", social: "Highly consistent and dependable social partners." },
            "DD": { status: "Moderate Risk", dynamic: "The Passive Merge", choices: "Decision-making is slow as neither wants to 'burden' the other.", social: "Extremely kind but can be socially indecisive or invisible." }
        };

        const QUESTIONS = [
            // VIBE CHECK (Questions 1-5)
            { id: 1, domain: 0, text: "During a heated argument, what is your most common reaction?", options: { A: "I counterattack.", B: "I give the silent treatment.", C: "I pause to regulate and understand.", D: "I apologize immediately just to stop the fight." } },
            { id: 2, domain: 0, text: "When your partner criticizes you, how do you usually respond?", options: { A: "I bring up their past mistakes.", B: "I walk away without a word.", C: "I try to find the kernel of truth in it.", D: "I accept all the blame to end the tension." } },
            { id: 3, domain: 0, text: "How quickly do you look to 'repair' after a disagreement?", options: { A: "Only after they admit they were wrong.", B: "I prefer to wait days until it blows over.", C: "I try to reach out within hours.", D: "I never let the argument start, I just give in." } },
            { id: 4, domain: 0, text: "What is your stance on the phrase 'Never go to bed angry'?", options: { A: "It's impossible; some things take days to settle.", B: "I prefer to sleep on it alone.", C: "We should at least acknowledge our love before sleeping.", D: "I will stay up all night begging for peace." } },
            { id: 5, domain: 0, text: "Do you ever feel 'contempt' (disgust or superiority) during a fight?", options: { A: "Yes, often when they seem incompetent.", B: "No, I just feel numb and bored.", C: "Rarely; I try to remember their worth.", D: "No, I'm too busy feeling guilty myself." } },

            // AXIS 1: Conflict Escalation Risk (CER) (Questions 6-13)
            { id: 6, domain: 1, text: "When conflict begins, my first instinct is:", options: { A: "Stay calm and discuss", B: "Clarify my point firmly", C: "Defend myself", D: "Raise intensity", E: "Shut down or withdraw" } },
            { id: 7, domain: 1, text: "If I feel disrespected, I:", options: { A: "Address it calmly", B: "Bring it up later", C: "Become sarcastic", D: "Confront aggressively", E: "Emotionally detach" } },
            { id: 8, domain: 1, text: "When tension rises, I:", options: { A: "Slow the conversation", B: "Try to reason logically", C: "Repeat my point", D: "Escalate to be heard", E: "Exit the conversation" } },
            { id: 9, domain: 1, text: "I believe arguments should:", options: { A: "End in resolution", B: "Be paused if heated", C: "Be won if necessary", D: "Establish dominance", E: "Be avoided entirely" } },
            { id: 10, domain: 1, text: "When my partner criticizes me, I:", options: { A: "Reflect and respond", B: "Clarify misunderstanding", C: "Justify myself", D: "Counter-attack", E: "Withdraw emotionally" } },
            { id: 11, domain: 1, text: "I am comfortable apologizing:", options: { A: "Immediately", B: "After reflection", C: "If both share blame", D: "Rarely", E: "Almost never" } },
            { id: 12, domain: 1, text: "During disagreement, my tone tends to:", options: { A: "Calm", B: "Firm", C: "Defensive", D: "Intense", E: "Cold" } },
            { id: 13, domain: 1, text: "After conflict, I:", options: { A: "Reconnect quickly", B: "Need brief space", C: "Stay distant for hours", D: "Replay it internally", E: "Shut down for days" } },

            // AXIS 2: Repair Velocity Gap (RVG) (Questions 14-21)
            { id: 14, domain: 2, text: "After tension, I prefer:", options: { A: "Immediate repair", B: "Short pause then repair", C: "Time alone first", D: "Avoiding discussion", E: "Pretending nothing happened" } },
            { id: 15, domain: 2, text: "Physical reassurance after conflict feels:", options: { A: "Necessary", B: "Helpful", C: "Neutral", D: "Uncomfortable", E: "Unwanted" } },
            { id: 16, domain: 2, text: "If conflict lingers, I:", options: { A: "Initiate resolution", B: "Wait briefly", C: "Assume partner should fix it", D: "Grow resentful", E: "Stop caring" } },
            { id: 17, domain: 2, text: "I define repair as:", options: { A: "Emotional clarity", B: "Verbal apology", C: "Behavioral change", D: "Silence restored", E: "Tension avoidance" } },
            { id: 18, domain: 2, text: "If I caused hurt, I:", options: { A: "Acknowledge clearly", B: "Explain context", C: "Minimize impact", D: "Deflect blame", E: "Ignore it" } },
            { id: 19, domain: 2, text: "When I’m hurt, I:", options: { A: "Say it directly", B: "Hint indirectly", C: "Expect them to know", D: "Become distant", E: "Withhold affection" } },
            { id: 20, domain: 2, text: "I believe unresolved conflict:", options: { A: "Damages intimacy", B: "Eventually fades", C: "Is normal", D: "Strengthens dominance", E: "Doesn’t matter" } },
            { id: 21, domain: 2, text: "Emotional distance after conflict makes me:", options: { A: "Uncomfortable quickly", B: "Slightly uneasy", C: "Neutral", D: "Relieved", E: "Safer" } },

            // AXIS 3: Financial Governance Misalignment (FGM) (Questions 22-29)
            { id: 22, domain: 3, text: "Financial decisions should be:", options: { A: "Joint and transparent", B: "Domain-based", C: "Led by higher earner", D: "Individual accounts separate", E: "Independent and private" } },
            { id: 23, domain: 3, text: "Major purchases require:", options: { A: "Mutual agreement", B: "Consultation", C: "Notification only", D: "Individual discretion", E: "No discussion required" } },
            { id: 24, domain: 3, text: "Debt is:", options: { A: "High caution", B: "Acceptable short-term", C: "Normal tool", D: "Necessary growth tool", E: "Not concerning" } },
            { id: 25, domain: 3, text: "Provision responsibility:", options: { A: "Shared equally", B: "Role-defined", C: "Primary earner leads", D: "Individual responsibility", E: "Undefined" } },
            { id: 26, domain: 3, text: "Financial secrecy is:", options: { A: "Unacceptable", B: "Rarely justified", C: "Situational", D: "Understandable", E: "Acceptable" } },
            { id: 27, domain: 3, text: "Giving/charity should be:", options: { A: "Structured and agreed", B: "Encouraged individually", C: "Flexible", D: "Optional", E: "Personal only" } },
            { id: 28, domain: 3, text: "Savings priority:", options: { A: "Mandatory", B: "Stronged encouraged", C: "If possible", D: "Minimal", E: "Not important" } },
            { id: 29, domain: 3, text: "If partner overspends:", options: { A: "Calm discussion", B: "Concern raised", C: "Frustration expressed", D: "Anger", E: "Withdrawal" } },

            // AXIS 4: Authority Structure Tension (AST) (Questions 30-37)
            { id: 30, domain: 4, text: "In marriage, leadership should be:", options: { A: "Mutual influence", B: "Domain-based", C: "One primary leader", D: "Situational power shifts", E: "Individual autonomy" } },
            { id: 31, domain: 4, text: "Final decision in stalemate:", options: { A: "Delayed until aligned", B: "Compromise", C: "Majority logic", D: "Stronger personality", E: "Whoever cares more" } },
            { id: 32, domain: 4, text: "Respect means:", options: { A: "Mutual honor", B: "Listening seriously", C: "Not challenging publicly", D: "Obedience", E: "Avoiding disagreement" } },
            { id: 33, domain: 4, text: "Submission means:", options: { A: "Voluntary cooperation", B: "Trusting leadership", C: "Role-based yielding", D: "Compliance", E: "Not applicable" } },
            { id: 34, domain: 4, text: "If I disagree strongly:", options: { A: "Seek understanding", B: "State position calmly", C: "Push until accepted", D: "Override if needed", E: "Withdraw" } },
            { id: 35, domain: 4, text: "I feel secure when:", options: { A: "Influence is mutual", B: "Structure is clear", C: "Authority is defined", D: "I retain autonomy", E: "I control decisions" } },
            { id: 36, domain: 4, text: "If partner leads poorly:", options: { A: "Discuss respectfully", B: "Suggest adjustment", C: "Take control", D: "Undermine privately", E: "Disengage" } },
            { id: 37, domain: 4, text: "Power imbalance makes me:", options: { A: "Curious", B: "Alert", C: "Defensive", D: "Angry", E: "Withdrawn" } },

            // AXIS 5: Attachment Trigger Instability (ATI) (Questions 38-45)
            { id: 38, domain: 5, text: "When I feel ignored:", options: { A: "Ask directly", B: "Seek reassurance", C: "Become distant", D: "Escalate", E: "Shut down" } },
            { id: 39, domain: 5, text: "When partner needs space:", options: { A: "Respect it calmly", B: "Ask timeframe", C: "Feel uneasy", D: "Take it personally", E: "Assume rejection" } },
            { id: 40, domain: 5, text: "Emotional closeness requires:", options: { A: "Consistency", B: "Verbal affirmation", C: "Physical affection", D: "Frequent contact", E: "Constant reassurance" } },
            { id: 41, domain: 5, text: "I fear:", options: { A: "Betrayal", B: "Emotional neglect", C: "Loss of control", D: "Being replaced", E: "Abandonment" } },
            { id: 42, domain: 5, text: "When stressed, I need:", options: { A: "Encouragement", B: "Problem-solving", C: "Silence", D: "Physical presence", E: "Withdrawal" } },
            { id: 43, domain: 5, text: "If partner pulls away:", options: { A: "Check in gently", B: "Wait briefly", C: "Press for answers", D: "Accuse distance", E: "Retreat emotionally" } },
            { id: 44, domain: 5, text: "Jealousy feels:", options: { A: "Rare", B: "Occasional", C: "Manageable", D: "Intense", E: "Overwhelming" } },
            { id: 45, domain: 5, text: "I feel most secure when:", options: { A: "Stability is consistent", B: "Communication is frequent", C: "Roles are clear", D: "Attention is high", E: "I control closeness" } },

            // AXIS 6: Stress Endurance Simulation
            { id: 46, domain: 6, text: "If we lost income:", options: { A: "Strategize calmly", B: "Tighten spending", C: "Stress heavily", D: "Blame", E: "Withdraw" } },
            { id: 47, domain: 6, text: "If extended family interferes:", options: { A: "Protect unity", B: "Mediate carefully", C: "Avoid confrontation", D: "Side with family", E: "Disengage" } },
            { id: 48, domain: 6, text: "If partner struggles spiritually:", options: { A: "Support patiently", B: "Encourage gently", C: "Worry privately", D: "Pressure change", E: "Distance emotionally" } },
            { id: 49, domain: 6, text: "Chronic illness would:", options: { A: "Deepen commitment", B: "Challenge but endure", C: "Cause fear", D: "Overwhelm", E: "Create resentment" } },
            { id: 50, domain: 6, text: "Under long stress I:", options: { A: "Stay steady", B: "Become anxious", C: "Become critical", D: "Become distant", E: "Shut down" } }
        ];

        // --- STATE ---
        let state = {
            view: 'landing',
            name: '',
            relationshipStatus: null,
            currentQuestion: 0,
            answers: [],
            p1Name: '',
            p1Data: null,
            isPartner2: false,
            syncing: false
        };

        const setView = (view) => { state.view = view; render(); };

        function render() {
            const content = document.getElementById('view-content');
            const progressContainer = document.getElementById('progress-container');
            content.innerHTML = '';

            if (state.view === 'landing') {
                progressContainer.classList.add('hidden');
                content.innerHTML = `
                    <div class="fade-in space-y-8 text-center my-auto">
                        <div class="space-y-4">
                            <h1 class="text-5xl font-bold tracking-tight text-white">Relation</h1>
                            <p class="text-xl text-slate-400 font-light max-w-md mx-auto">"Identify hidden friction points and align your relationship architecture."</p>
                        </div>
                        <div class="max-w-sm mx-auto space-y-6">
                            <input id="user-name" type="text" placeholder="Enter your name" class="w-full bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-4 text-center text-lg outline-none focus:ring-2 focus:ring-violet-500 transition-all">
                            <div class="space-y-4 flex flex-col items-center">
                                <button onclick="startApp('Single')" class="w-full bg-violet-600 py-4 rounded-xl font-semibold text-lg hover:bg-violet-500 transition-all shadow-lg shadow-violet-500/20">Single: Preparing for my future</button>
                                <button onclick="startApp('Coupled')" class="w-full glass py-4 rounded-xl font-semibold text-lg hover:bg-slate-800 transition-all border border-slate-700">In a Relationship: Strengthening us</button>
                            </div>
                        </div>
                        <p class="text-sm text-slate-500 italic">"Start your project with a 5-Question Vibe Check."</p>
                    </div>
                `;
            } else if (state.view === 'quiz') {
                progressContainer.classList.remove('hidden');
                const q = QUESTIONS[state.currentQuestion];
                const progress = ((state.currentQuestion) / QUESTIONS.length) * 100;
                document.getElementById('progress-bar').style.width = `${progress}%`;

                content.innerHTML = `
                    <div class="quick-fade space-y-8">
                        <div class="space-y-2">
                            <span class="text-xs font-bold uppercase tracking-widest text-violet-400">${DOMAINS[q.domain]}</span>
                            <h2 class="text-2xl font-medium leading-snug">${q.text}</h2>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            ${Object.entries(q.options).map(([key, text]) => `
                                <div onclick="selectOption(this, '${key}')" class="option-card p-5 rounded-2xl glass border-slate-800 hover:border-violet-500/50 flex items-center space-x-4">
                                    <span class="w-8 h-8 rounded-full flex items-center justify-center bg-slate-800 text-slate-400 font-bold text-sm">${key}</span>
                                    <span class="text-lg text-slate-200">${text}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (state.view === 'teaser') {
                progressContainer.classList.remove('hidden');
                const teaser = getTeaserInsight();
                content.innerHTML = `
                    <div class="fade-in space-y-8 text-center my-auto">
                        <div class="flex flex-col items-center space-y-4">
                            <div class="loader w-12 h-12 border-4 border-slate-800 rounded-full mb-4"></div>
                            <h3 class="text-xl font-bold">Analyzing Behavioral Baseline...</h3>
                        </div>
                        <div class="space-y-6 text-left">
                            <div class="p-6 rounded-2xl bg-slate-800/50 border border-slate-700 space-y-2">
                                <p class="text-violet-400 font-bold uppercase text-xs tracking-widest">1. Your Baseline Tendency</p>
                                <p class="text-lg text-slate-200">${teaser.baseline}</p>
                            </div>
                            <div class="p-6 rounded-2xl bg-slate-800/50 border border-slate-700 space-y-2">
                                <p class="text-violet-400 font-bold uppercase text-xs tracking-widest">2. The Hidden Risk</p>
                                <p class="text-lg text-slate-300 italic">"${teaser.risk}"</p>
                            </div>
                            <div class="p-6 rounded-2xl bg-violet-600/10 border border-violet-600/20 space-y-3">
                                <p class="text-violet-500 font-bold uppercase text-xs tracking-widest">3. The Cliffhanger</p>
                                <p class="text-sm text-slate-300 leading-relaxed">"Your surface baseline is clear, but we haven't mapped your relational architecture. Most relationships collapse because they ignore the 'MRI' level—attachment triggers, financial transparency, and conflict repair speed. You are 10% away from your full Blueprint."</p>
                            </div>
                        </div>
                        <button onclick="setView('quiz')" class="w-full py-4 bg-violet-600 rounded-xl font-bold animate-pulse shadow-lg shadow-violet-500/40">Continue for a full assessment (FREE)</button>
                    </div>
                `;
            } else if (state.view === 'results') {
                progressContainer.classList.add('hidden');
                const scores = calculateScores();

                content.innerHTML = `
                    <div class="fade-in space-y-12 pb-12">
                        <div class="text-center space-y-2">
                            <h2 class="text-4xl font-bold text-white">Your Relation Blueprint</h2>
                            <p class="text-slate-400">Comprehensive Relational Diagnostic for <b>${state.name || "User"}</b>.</p>
                        </div>

                        <div class="space-y-4">
                            <h4 class="text-sm font-bold text-slate-500 uppercase tracking-widest text-center mb-6">Friction Axis Analysis</h4>
                            ${Object.entries(scores).map(([domain, data]) => `
                                <div class="bg-slate-800/30 p-5 rounded-2xl border border-slate-800 space-y-3">
                                    <div class="flex justify-between items-end">
                                        <p class="text-xs font-bold uppercase tracking-widest text-slate-500">${DOMAINS[domain]}</p>
                                        <p class="text-sm font-bold text-violet-400">${data.label}</p>
                                    </div>
                                    <div class="w-full h-1.5 bg-slate-900 rounded-full overflow-hidden">
                                        <div class="h-full vibrant-gradient" style="width: ${data.score}%"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        ${renderAlignmentForecast(scores)}

                        <div class="pt-8 border-t border-slate-800 text-center space-y-6">
                            <div id="sync-status" class="bg-blue-500/10 border border-blue-500/20 py-2 px-4 rounded-full inline-flex items-center space-x-2">
                                <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                                <span id="sync-text" class="text-xs text-blue-400 font-bold uppercase tracking-widest">Relational Data Encrypted & Synced</span>
                            </div>
                            <div class="space-y-4">
                                <p class="text-slate-500 text-sm italic">Request your full relationship architecture PDF diagnostic.</p>
                                <input type="email" id="email-capture" placeholder="Enter your email" class="w-full max-w-sm bg-slate-800 border-slate-700 rounded-xl px-4 py-3 mb-4 focus:ring-2 focus:ring-violet-500 outline-none block mx-auto text-center">
                                <button id="send-report-btn" onclick="syncToWebhook(true)" class="text-violet-400 hover:text-white transition-colors text-sm font-bold uppercase tracking-widest">Send Report to Engine</button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function startApp(status) {
            state.name = document.getElementById('user-name').value || (state.isPartner2 ? "Partner 2" : "Partner 1");
            state.relationshipStatus = status;
            setView('quiz');
        }

        function selectOption(el, option) {
            // Add selected class to the clicked element
            if (el) el.classList.add('selected');

            // Slight delay for visual feedback before transition
            setTimeout(() => {
                state.answers.push(option);
                state.currentQuestion++;
                if (state.currentQuestion === 5) setView('teaser');
                else if (state.currentQuestion >= QUESTIONS.length) { syncToWebhook(false); setView('results'); }
                else render();
            }, 100);
        }

        const DOMAIN_INTERACTIONS = {
            1: { // Conflict & Repair
                "AA": "High Volatility. Both counter-attack, leading to escalating power struggles.",
                "AB": "The Chaser & The Ghost. One attacks while the other retreats into silence.",
                "AC": "Balanced Intensity. A dominant leader met with a regulating anchor.",
                "AD": "Internalized Tension. One drives the conflict while the other yield in fear.",
                "CC": "Covenant Repair. Mutual de-escalation and rapid restoration of peace.",
                "DD": "Silent Simmer. Conflict is avoided, leading to hidden resentment."
            },
            2: { // Finance & Partnership
                "AA": "Financial Cold War. Competing for control over the 'War Chest'.",
                "CC": "Shared Stewardship. Total transparency and unified financial vision.",
                "BC": "Analytical Guardrails. Logic meets security, ensuring cautious stability.",
                "AD": "Logistical Imbalance. One manages all power while the other feels like a passenger."
            },
            3: { // Intimacy & Loyalty
                "AA": "Transactional Connection. Validation through achievement rather than vulnerability.",
                "BB": "The Isolated Island. Both retreat into screens or hobbies when safety is low.",
                "CC": "Vulnerable Proximity. Proactive initiation and emotional transparency.",
                "AC": "Deep Loyalty. A strong protector met by a warm, supportive anchor."
            },
            4: { // Attachment & Safety
                "AA": "Hyper-Independence. Both fear dependency, keeping a 'back door' open.",
                "CC": "Secure Base. A home environment where both feel safe to be fully seen.",
                "BD": "Passive Avoidance. Distance is the default, and needs are suppressed."
            },
            5: { // Vision & Values
                "AA": "Mission Conflict. Competing singular paths with no room for a joint map.",
                "CC": "Covenant Unity. A shared singular mission that serves a higher purpose.",
                "CD": "Adaptive Vision. One leads with security while the other stabilizes the path."
            }
        };

        const RECOMMENDED_RESOURCES = {
            A: { title: "The Seven Principles for Making Marriage Work", author: "John Gottman", link: "#", reason: "To help you transition from dominance to 'accepting influence'." },
            B: { title: "Hold Me Tight", author: "Sue Johnson", link: "#", reason: "To help you identify your 'Protest Polka' and return from detachment." },
            C: { title: "The Meaning of Marriage", author: "Timothy Keller", link: "#", reason: "To strengthen your understanding of sacrificial, covenantal love." },
            D: { title: "Boundaries in Marriage", author: "Henry Cloud", link: "#", reason: "To help you find your voice and stop the pattern of silent yielding." }
        };

        const ASYMMETRY_DATA = {
            conflict: {
                diagnosis: "Your data indicates a risk of 'The Crazy Cycle.' This occurs when a husband feels disrespected and reacts in ways that feel unloving, or a wife feels unloved and reacts in ways that seem disrespectful. If one partner defaults to Contempt (mockery or talking down) and the other to Stonewalling (withdrawal), your 'Relationship Wall' is accruing cracks that will eventually lead to structural failure. +4",
                interventions: [
                    { title: "Practice the 'Softened Start-up'", desc: "Never begin a difficult conversation with a 'Harsh Start-up' (criticism or 'You' statements). Instead, state a neutral feeling and a specific, positive need. +4" },
                    { title: "The 20-Minute 'Flooding' Protocol", desc: "If your heart rate spikes, you are likely 'Flooding' and cannot process logic. You must take a mandatory 20-minute break to self-soothe before re-engaging. +4" },
                    { title: "Accepting Influence", desc: "Success requires a 'Yield to Win' mentality. You must intentionally accept your partner's point of view as valid, even if you disagree with the set of facts. +4" }
                ]
            },
            boundary: {
                diagnosis: "We are scanning for 'Enmeshment' vs. 'Autonomy.' If your scores show a lack of 'Property Lines,' you are likely taking responsibility for your partner's feelings rather than being responsible to them. Yielding your boundaries just to keep the peace is a form of 'Courtship Deception' that leads to long-term resentment. +3",
                interventions: [
                    { title: "The Law of Responsibility", desc: "You are responsible for your own 'treasures'—your time, money, and feelings. You must stop 'Rescuing' your partner from the natural consequences of their actions. +3" },
                    { title: "The 'Leave and Cleave' Boundary", desc: "Your primary allegiance must transfer from your family of origin to your partner. External family must not be allowed to overrule your internal consensus. +2" }
                ]
            }
        };

        const RESOURCE_LIBRARY = [
            { cat: "Conflict Mastery", books: "Fight Right (Gottman) and The Lost Art of Listening (Nichols). +1" },
            { cat: "Emotional Safety", books: "Hold Me Tight (Johnson) and Getting the Love You Want (Hendrix). +1" },
            { cat: "Biblical Alignment", books: "Love & Respect (Eggerichs) and The Love Dare (Kendrick). +1" },
            { cat: "Personal Autonomy", books: "Boundaries (Cloud & Townsend) and 8 Rules of Love (Shetty). +1" }
        ];

        const TIER_WORKSHEETS = {
            1: {
                name: "The Greenhouse (High Alignment)",
                goal: "Creating Shared Meaning",
                steps: [
                    { title: "The Love Map Challenge", desc: "List your partner's best friends, current stressors, and biggest life dreams. +2" },
                    { title: "The 'I Appreciate' Ritual", desc: "Every day for one week, pick one positive characteristic of your partner and tell them a specific incident where they displayed it. +1" }
                ],
                verse: "Biblical Foundation: 'Stimulate one another to love and good deeds' (Hebrews 10:24)."
            },
            2: {
                name: "The Repair Shop (Moderate Friction)",
                goal: "Mastering the 'Do-over'",
                steps: [
                    { title: "The Bagel Method", desc: "Draw two circles. In the small inner circle, write your non-negotiable needs regarding a conflict. In the outer circle, list areas where you can be flexible. Compare and find a 'Third Way' compromise. +4" },
                    { title: "The Repair Checklist", desc: "Keep a physical list of repair phrases (e.g., 'I'm feeling defensive,' 'I see your point') and use them mid-fight to de-escalate. +1" }
                ],
                verse: "Biblical Foundation: 'Be quick to hear, slow to speak, and slow to anger' (James 1:19)."
            },
            3: {
                name: "The Boundary Lab (High Tension)",
                goal: "Establishing Property Lines",
                steps: [
                    { title: "The Emotional Inventory", desc: "Describe a recent argument using only 'I Feel' statements. Identify which 'Raw Spot' from your childhood was triggered. +3" },
                    { title: "Closing the 'Exits'", desc: "Identify any 'exits' you use to avoid intimacy (e.g., overworking, social media, triangulation with parents) and commit to closing them for 30 days. +1" }
                ],
                verse: "Biblical Foundation: 'Let your 'Yes' be 'Yes' and your 'No,' 'No'' (Matthew 5:37)."
            },
            4: {
                name: "The Crisis Reset (Critical Risk)",
                goal: "Stopping the Bleeding",
                steps: [
                    { title: "The Love Dare 24-Hour Fast", desc: "For 24 hours, you are forbidden from speaking a single negative word to or about your partner. +1" },
                    { title: "The Surrender Protocol", desc: "Identify one area where you are competing to 'win'. Commit to accepting your partner's influence in that area entirely for one week. +3" }
                ],
                verse: "Biblical Foundation: 'Love is patient... it keeps no record of wrongs' (1 Corinthians 13:4-5)."
            }
        };

        const VETTING_MRI = {
            prep: [
                { title: "Define Your Non-Negotiables", desc: "Based on the 'Bagel Method,' what are your core values that you cannot sacrifice for chemistry? +1" },
                { title: "Identify Your Imago", desc: "List the positive and negative traits of your primary caretakers. Be aware that you will naturally be attracted to someone who mirrors these traits. +2" }
            ],
            questions: [
                { q: "Conflict Speed", desc: "Ask: 'What is the longest you've ever gone without speaking to someone you were mad at?' (Scanning for Stonewalling/Withdrawal). +2" },
                { q: "Authority & Cleaving", desc: "Ask: 'How do you handle it when your parents disagree with a major decision you've made?' (Scanning for lack of boundaries). +1" },
                { q: "Ownership", desc: "Ask: 'Tell me about a time you were 'the bad guy' in a past relationship and how you fixed it.' (Scanning for Defensiveness). +2" }
            ],
            redFlags: [
                { f: "Contempt", desc: "Do they roll their eyes or use cutting sarcasm when you express a need? +1" },
                { f: "Deactivating Strategies", desc: "Do they pull away or become cold the moment things get 'too close'? +1" },
                { f: "Consumer Mindset", desc: "Do they view the relationship as a way to 'make them happy' rather than a shared mission? +1" }
            ]
        };

        function calculateFrictionScore(p1Ans, p2Ans) {
            const weights = {
                AA: 10, AB: 9, BA: 9, BB: 8,
                AD: 7, DA: 7, BD: 6, DB: 6,
                DD: 4, AC: 2, CA: 2, BC: 2,
                CB: 2, CD: 1, DC: 1, CC: 0
            };
            let total = 0;
            p1Ans.forEach((ans, i) => {
                const pair = ans + (p2Ans[i] || "C");
                total += weights[pair] || 0;
            });
            return total;
        }

        function getTeaserInsight() {
            const counts = { A: 0, B: 0, C: 0, D: 0 };
            state.answers.forEach(a => counts[a]++);
            if (counts.A >= 2) return { baseline: "The Challenger: You have a natural leadership drive and prioritize efficiency.", risk: "Leadership can blur into dominance. If you don't build a 'veto culture', your partner may learn to appease rather than align." };
            if (counts.B >= 2) return { baseline: "The Strategist: You value autonomy and seek logical distance before emotional commitments.", risk: "Independence is your armor, but it can starve the relationship of 'proximate safety.' Withdrawal is a slow leak in intimacy." };
            if (counts.C >= 2) return { baseline: "The Peacemaker: You prioritize harmony and de-escalate tension through collaborative logic.", risk: "Yielding to avoid conflict often leads to silent resentment and internalizing tension, which is a form of courtship deception." };
            if (counts.D >= 2) return { baseline: "The Nurturer: You are highly empathetic and prioritize the emotional comfort of others over your own needs.", risk: "Passive adaptation creates a 'one-way map' where your partner never actually meets the real you." };
            return { baseline: "The Observer: You are analytical, cautious, and favor observation over immediate reaction.", risk: "Delayed intensity can miss the window for repair, leaving your partner feeling isolated." };
        }

        const SCORING_MAP = { A: 1, B: 2, C: 3, D: 4, E: 5 };

        function calculateScores(answersArr) {
            const target = (answersArr || state.answers).map(a => SCORING_MAP[a] || 3);
            const res = {};

            // If we have partner data, calculate friction
            const partnerData = state.isPartner2 ? state.p1Answers.map(a => SCORING_MAP[a] || 3) : null;

            for (let d = 1; d <= 6; d++) {
                const domainQuestions = QUESTIONS.filter(q => q.domain === d);
                const domainSize = domainQuestions.length;
                const axisAnswers = [];

                // Get answers for this domain.
                domainQuestions.forEach(q => {
                    // Find index in QUESTIONS array (matches state.answers index)
                    const idx = QUESTIONS.findIndex(item => item.id === q.id);
                    if (idx !== -1 && target[idx] !== undefined) {
                        axisAnswers.push({ user: target[idx], partner: partnerData && partnerData[idx] !== undefined ? partnerData[idx] : null });
                    }
                });

                let axisScore = 0;
                if (partnerData) {
                    const rawDiff = axisAnswers.reduce((sum, item) => sum + Math.abs(item.user - (item.partner || item.user)), 0);
                    axisScore = (rawDiff / (domainSize * 5)) * 100;
                } else {
                    // For single user, just show a "baseline" or average (not strictly required by user but good for UI)
                    const avg = axisAnswers.reduce((sum, item) => sum + item.user, 0) / domainSize;
                    axisScore = (avg / 5) * 100;
                }

                res[d] = {
                    score: axisScore,
                    label: getThresholdLabel(axisScore)
                };
            }
            return res;
        }

        function getThresholdLabel(score) {
            if (score <= 20) return "Stable";
            if (score <= 40) return "Watch Zone";
            if (score <= 60) return "Moderate Risk";
            if (score <= 80) return "High Tension";
            return "Structural Instability";
        }

        function renderAlignmentForecast(p2Scores) {
            const scores = p2Scores || calculateScores();
            const p1Name = state.isPartner2 ? state.p1Name : state.name;
            const p2Name = state.isPartner2 ? state.name : "Partner";

            const blurClass = state.isPartner2 ? "" : "blur-content";

            return `
                <div class="space-y-12 pt-12 border-t border-slate-800 relative">
                    ${!state.isPartner2 ? `
                        <div class="absolute inset-0 z-10 flex flex-col items-center justify-center bg-slate-900/40 backdrop-blur-[2px] rounded-3xl p-8 text-center pt-24">
                            <div class="bg-violet-600 p-8 rounded-3xl shadow-2xl space-y-4 max-w-sm border border-violet-400/30">
                                <h4 class="text-xl font-bold text-white">Unlock Combined Forecast</h4>
                                <p class="text-slate-200 text-sm">Your individual data is ready. To reveal your interaction dynamic and growth plan, sync with your partner.</p>
                                <button onclick="generatePartnerLink()" class="w-full py-3 bg-white text-violet-600 rounded-xl font-bold hover:bg-slate-100 transition-all">Copy Partner Link</button>
                            </div>
                        </div>
                    ` : ''}

                    <div class="text-center space-y-4">
                        <h3 class="text-3xl font-bold text-violet-400">The Alignment Forecast: ${p1Name} & ${p2Name}</h3>
                    </div>

                    <div class="grid grid-cols-1 gap-6">
                        <div class="p-8 rounded-3xl bg-slate-800/40 border border-slate-700 space-y-4">
                            <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500 text-center">Joint Friction Analysis</h4>
                            <div class="space-y-5 ${blurClass}">
                                ${Object.entries(scores).map(([id, data]) => `
                                    <div class="border-b border-slate-800/50 pb-4 last:border-0 last:pb-0 flex justify-between items-center">
                                        <p class="text-slate-200 text-sm font-bold">${DOMAINS[id]}</p>
                                        <p class="text-violet-400 font-bold text-sm tracking-widest uppercase">${data.label}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="text-center space-y-4 pt-8">
                        <p class="text-slate-400 text-sm">Request your full relationship architecture PDF diagnostic</p>
                        <div class="max-w-md mx-auto flex gap-2">
                            <input type="email" id="webhookEmail" placeholder="Enter your email" class="flex-1 px-4 py-3 rounded-xl bg-slate-800 border border-slate-700 text-white text-sm focus:outline-none focus:border-violet-500">
                            <button id="syncBtn" onclick="syncToWebhook()" class="px-6 py-3 bg-violet-600 hover:bg-violet-700 text-white rounded-xl font-bold text-sm transition-all shadow-lg whitespace-nowrap uppercase tracking-widest">Send Report to Engine</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function generatePartnerLink() {
            const payload = btoa(JSON.stringify({ name: state.name, answers: state.answers }));
            const url = new URL(window.location.href);
            url.searchParams.set('p1', payload);
            navigator.clipboard.writeText(url.toString());
            alert("Secret link copied! Send this to your partner.");
        }

        function checkParams() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('p1')) {
                try {
                    const data = JSON.parse(atob(params.get('p1')));
                    state.p1Name = data.name || "Partner 1";
                    state.p1Answers = data.answers || [];
                    state.isPartner2 = true;
                } catch (e) { }
            }
        }

        async function syncToWebhook(isManual = false) {
            const email = document.getElementById('email-capture')?.value || "";
            const btn = document.getElementById('send-report-btn');
            const syncText = document.getElementById('sync-text');

            const payload = {
                timestamp: new Date().toISOString(),
                name: state.name,
                partner_name: state.isPartner2 ? state.p1Name : null,
                status: state.relationshipStatus,
                user_type: state.isPartner2 ? "P2" : "P1",
                answers: state.answers,
                email: email
            };

            if (isManual) {
                btn.disabled = true;
                btn.textContent = "SENDING...";
                syncText.textContent = "COMMUNICATING WITH ENGINE...";
            }

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (isManual) {
                    btn.textContent = "REPORT SENT";
                    btn.classList.add('text-green-400');
                    syncText.textContent = "RELATIONAL DATA ENCRYPTED & SYNCED";
                }
            } catch (e) {
                if (isManual) {
                    btn.disabled = false;
                    btn.textContent = "SYNC FAILED - RETRY";
                    syncText.textContent = "SYNC ERROR - CHECK CONNECTION";
                }
            }
        }

        function getLabel(t) { return { A: "Dominant", B: "Avoidant", C: "Secure", D: "Passive" }[t] || "Unknown"; }

        checkParams();
        render();
    </script>
</body>

</html>